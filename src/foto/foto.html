<!DOCTYPE html>
<html lang="es-MX">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Foto</title>
    <style>
        .messageError {
            margin:0.5em; padding:0.3em;
            border:1px red solid;
            color: red;font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>

    <div style="margin:1em">
        <label for="cameraSelect">Camara: </label><select id="cameraSelect"></select>
        <button type="button" id="takePicture">Click</button>
        <button type="button" id="fotoUploadBtn" style="visibility: hidden">Save</button>
        <button type="button" id="cameraRetry" style="visibility: hidden">Retry</button>
    </div>
    <div class="messageError" id="messageError"></div>
    <video id="video" autoplay></video>
    <div>
        <img id="capturedImage" src="" alt="">
        <input type="hidden" id="lat" name="latitude" value="">
        <input type="hidden" id="lon" name="longitude" value="">
        <input type="file" id="imageUpload" name="imageUpload" style="display:none">
    </div>
    <script>
        let messagesDisplay = {
            messageError: document.getElementById('messageError'),
            set: function(message) {
                this.messageError.innerHTML = message;
                this.messageError.style.display = 'block';
            },
            append:function(message) {
                this.messageError.innerHTML += "<div>" + message + "</div>";
                this.messageError.style.display = 'block';
            },

            clear: function() {
                this.messageError.innerHTML = '';
                this.messageError.style.display = 'none';
            },
        }
    </script>
    <script>
        function setupCamera() {
            const videoElement = document.getElementById('video');
            const cameraSelect = document.getElementById('cameraSelect');
            const buttonTakePicture = document.getElementById('takePicture');
            const buttonRetry = document.getElementById('cameraRetry');
            const buttonUpload = document.getElementById('fotoUploadBtn');
            messagesDisplay.clear();
            // Check for MediaDevices support
            if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                navigator.mediaDevices.enumerateDevices()
                    .then(populateCameraList)
                    .catch(handleCameraError);
            } else {
               messagesDisplay.set('MediaDevices not supported');
            }

            function populateCameraList(devices) {
                devices.forEach(device => {
                    if (device.kind === 'videoinput') {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `Camera ${cameraSelect.length + 1}`;
                        cameraSelect.add(option);
                    }
                });

                // Start with the first camera (if any)
                if (cameraSelect.options.length > 0) {
                    startStream(cameraSelect.value);
                }
            }

            function handleCameraError(error) {
                messagesDisplay.append('Error accessing cameras: ' + error);
            }

            function startStream(deviceId) {
                const constraints = {
                    video: { deviceId: deviceId ? { exact: deviceId } : true } // Select specific camera
                };

                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        videoElement.srcObject = stream;
                        videoElement.play();
                    })
                    .catch(handleCameraError);
            }

            cameraSelect.addEventListener('change', () => {
                startStream(cameraSelect.value);
            });

            buttonTakePicture.addEventListener('click', () => {
                const canvas = document.createElement('canvas');
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                canvas.getContext('2d').drawImage(videoElement, 0, 0);
                // Resize the image
                const resizedCanvas = document.createElement('canvas');
                const desiredWidth = 640; //
                const aspectRatio = canvas.width / canvas.height;
                const desiredHeight = desiredWidth / aspectRatio;
                resizedCanvas.width = desiredWidth;
                resizedCanvas.height = desiredHeight;
                resizedCanvas.getContext('2d').drawImage(canvas, 0, 0, desiredWidth, desiredHeight);
                canvas.remove();
                const imageData = resizedCanvas.toDataURL('image/jpeg', 0.8); // 0.7 for ~70% quality
                const imageElement = document.getElementById('capturedImage');
                imageElement.src = imageData;
                resizedCanvas.toBlob(function(blob) {
                    const imageFile = new File([blob], "capturedImage.jpg", {type: "image/jpeg"});
                    //document.getElementById('imageUpload').files = [imageFile];
                    const stream = videoElement.srcObject;
                    const tracks = stream.getTracks();
                    tracks.forEach(track => track.stop());
                    videoElement.srcObject = null;
                    videoElement.style.display = 'none';
                    document.getElementById('capturedImage').style.display = '';
                    buttonTakePicture.style.visibility = 'hidden';
                    buttonUpload.style.visibility = 'visible';
                    buttonRetry.style.visibility = 'visible';
                    resizedCanvas.remove();
                }, 'image/jpeg', 0.8);
            });

            buttonRetry.addEventListener('click', () => {
                console.log("retruing", cameraSelect.value);
                videoElement.style.display = '';
                buttonTakePicture.style.visibility = 'visible';
                buttonUpload.style.visibility = 'hidden';
                buttonRetry.style.visibility = 'hidden';
                startStream(cameraSelect.value);
            });
        }
    </script>
    <script>
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, handleGeolocationError);
            } else {
                messagesDisplay.append('Geolocation is not supported by this browser.');
            }
        }

        function showPosition(position) {
            document.getElementById('lat').value = position.coords.latitude;
            document.getElementById('lon').value = position.coords.longitude;
        }

        function handleGeolocationError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    messagesDisplay.append("Localización: Necesito el permiso y fue negado.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    messagesDisplay.append("Localización no disponible, Time Out.");
                    break;
                default:
                    messagesDisplay.append("Localización: Error inesperado.");
                    break;
            }
        }

    </script>
<script>
    window.addEventListener('DOMContentLoaded', setupCamera);
    window.addEventListener('DOMContentLoaded', getLocation);
</script>
</body>
</html>